/******************************************************************************
LTR303 Arduino
For UCA21
MODIFIED

Use LTR303 light sensor

Objective : This code will :
    * use the light meter to move a servomotor
******************************************************************************/

#include <LTR303.h>
#include <Wire.h>

// Création d'un objet LTR303 nommé "light":
LTR303 light;

// Variable Globales:
unsigned char gain;     // Valeur du gain comprise entre 0 et 7 (le gain permet d'augmenter la sensibilité du luxmètre)   
unsigned char integrationTime;  // Temps en miliseconde pendant lequel le capteur absorbe la lumière avant de faire une mesure

void setup() {
  delay(3000); // On laisse le luxmètre s'allumer doucement
  // On initialize le Serial port:
  Serial.begin(115200);

  // On laisse le tout se reveiller
  delay(100);

  // On prépare le capteur (il ne prend pas encore de mesure mais est allumé)
  light.begin();


  // Le gain peut être entre 0 et 7 sauf 4 et 5
  // La valeur de gain par défaut est 0
  gain = 0;
  light.setControl(gain, false, false);

  // Si integrationTime = 1 alors la durée sera de 50 ms
  integrationTime = 1;
  light.setMeasurementRate(integrationTime, 3);

  // On lance le capteur pour qu'il prenne des mesures :
  light.setPowerUp();

  Serial.println("Data0:,Data1:,Lux:");   // On affiche les titres dans le moniteur série
}

void loop() {
  // On attend entre les mesures pour afficher les résultats 
  int ms = 50;
  delay(ms);

  // On récupère les données du luxmètre:
  unsigned int data0, data1;
  double lux;    // "double" = float donc on initialise une variable décimale lux 
  boolean good;  // Si on sature aucun capteurs, cette valeur renvoie vrai

  if (light.getData(data0, data1)) {
    // on teste la commmunication
    Serial.print(data1);
    Serial.print(" ");
    Serial.print(data0);
    Serial.print(" ");

    // On calcule la valeur du luxmètre en lux:
    good = light.getLux(gain, integrationTime, data0, data1, lux);

    // On affiche le résultat dans le moniteur série:
    Serial.println(lux);
  }
  else {
    // getData() a renvoyé "False" à cause d'un problème I2C (donc capteur mal branché/mauvais endroits/etc...)
    byte error = light.getError();
    printError(error);
  }
}

